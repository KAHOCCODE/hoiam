<!DOCTYPE html>
<html lang="vi" class="scroll-smooth">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>H·ªìi √Çm ƒêam M·ªπ - V≈© Tr·ª• Truy·ªán</title>
<link rel="icon" type="image/x-icon" href="favicon.ico">

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
<script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>

<script>
    tailwind.config = {
        theme: {
            extend: {
                colors: {
                    night: '#0B0B15',
                    glass: 'rgba(255, 255, 255, 0.05)',
                    glassBorder: 'rgba(255, 255, 255, 0.1)',
                    primary: '#8B5CF6',
                    secondary: '#EC4899'
                },
                fontFamily: {
                    sans: ['Quicksand', 'sans-serif'],
                },
                animation: {
                    'blob': 'blob 7s infinite',
                    'spin-slow': 'spin 12s linear infinite',
                },
                keyframes: {
                    blob: {
                        '0%': { transform: 'translate(0px, 0px) scale(1)' },
                        '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                        '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                        '100%': { transform: 'translate(0px, 0px) scale(1)' },
                    }
                }
            }
        }
    }
</script>

<style>
    @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&display=swap');
    
    body { background-color: #0B0B15; color: #E2E8F0; font-family: 'Quicksand', sans-serif; overflow-x: hidden; }

    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #0B0B15; }
    ::-webkit-scrollbar-thumb { background: #4c1d95; border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: #6d28d9; }

    /* Glass Effect Class */
    .glass-panel {
        background: rgba(17, 24, 39, 0.7);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.08);
        box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
    }

    /* Gradient Text */
    .text-gradient {
        background: linear-gradient(to right, #c084fc, #f472b6);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    /* Loader */
    .loader {
        width: 48px; height: 48px;
        border: 3px solid #FFF;
        border-bottom-color: #8B5CF6;
        border-radius: 50%;
        display: inline-block;
        box-sizing: border-box;
        animation: rotation 1s linear infinite;
        margin: 20px auto;
    }
    @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* Heart Animation */
    .heart-pop:active { transform: scale(0.8); }
    .heart-pop.active { color: #ef4444; animation: heartBeat 0.5s forwards; }
    @keyframes heartBeat {
        0% { transform: scale(1); }
        25% { transform: scale(1.3); }
        50% { transform: scale(1); }
        75% { transform: scale(1.1); }
        100% { transform: scale(1); }
    }
</style>
</head>

<body class="antialiased selection:bg-purple-500 selection:text-white">

    <canvas id="stars" class="fixed top-0 left-0 w-full h-full -z-20 opacity-60"></canvas>
    <div class="fixed top-0 left-0 w-full h-full overflow-hidden -z-10 pointer-events-none">
        <div class="absolute top-0 left-1/4 w-96 h-96 bg-purple-600 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-blob"></div>
        <div class="absolute top-0 right-1/4 w-96 h-96 bg-indigo-600 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-blob animation-delay-2000"></div>
        <div class="absolute -bottom-32 left-1/3 w-96 h-96 bg-pink-600 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-blob animation-delay-4000"></div>
    </div>

    <nav class="fixed w-full z-50 transition-all duration-300 top-0 glass-panel border-t-0 border-x-0">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <a href="#home" class="flex items-center gap-3 group cursor-pointer">
                    <div class="relative w-8 h-8 flex items-center justify-center">
                        <div class="absolute inset-0 bg-gradient-to-tr from-purple-500 to-pink-500 rounded-full animate-spin-slow blur-[2px] opacity-70"></div>
                        <div class="relative w-full h-full bg-black rounded-full border border-white/20 flex items-center justify-center">
                            <i class="fa-solid fa-compact-disc text-purple-400 text-lg"></i>
                        </div>
                    </div>
                    <span class="text-xl font-bold tracking-wider text-white group-hover:text-purple-300 transition">H·ªìi√Çm<span class="text-purple-400">ƒêamM·ªπ</span></span>
                </a>

                <div class="hidden md:flex items-center space-x-8">
                    <a href="#home" class="text-sm font-medium text-gray-300 hover:text-white transition hover:scale-105">Trang ch·ªß</a>
                    <a href="#reading" class="text-sm font-medium text-gray-300 hover:text-white transition hover:scale-105">ƒêang ph√°t</a>
                    <a href="#suggest" class="text-sm font-medium text-gray-300 hover:text-white transition hover:scale-105">ƒê·ªÅ xu·∫•t</a>
                    <a href="#list" class="text-sm font-medium text-gray-300 hover:text-white transition hover:scale-105">Kho truy·ªán</a>
                    <button id="adminLoginBtn" class="text-gray-400 hover:text-white transition"><i class="fa-solid fa-gear"></i></button>
                </div>

                <button id="mobileMenuBtn" class="md:hidden text-gray-300 hover:text-white focus:outline-none text-xl">
                    <i class="fa-solid fa-bars-staggered"></i>
                </button>
            </div>
        </div>
        
        <div id="mobileMenu" class="hidden md:hidden glass-panel border-t border-white/10 absolute w-full">
            <div class="px-4 pt-2 pb-6 space-y-1">
                <a href="#home" class="block px-3 py-3 rounded-md text-base font-medium text-gray-300 hover:text-white hover:bg-white/10">Home</a>
                <a href="#reading" class="block px-3 py-3 rounded-md text-base font-medium text-gray-300 hover:text-white hover:bg-white/10">Radio ƒêang Ph√°t</a>
                <a href="#suggest" class="block px-3 py-3 rounded-md text-base font-medium text-gray-300 hover:text-white hover:bg-white/10">G·ª≠i ƒë·ªÅ xu·∫•t</a>
                <a href="#list" class="block px-3 py-3 rounded-md text-base font-medium text-gray-300 hover:text-white hover:bg-white/10">Danh s√°ch truy·ªán</a>
                <div class="pt-4 border-t border-white/10 mt-2">
                    <button id="adminLoginBtnMobile" class="w-full text-left px-3 py-2 text-sm text-gray-500 hover:text-gray-300 flex items-center gap-2">
                        <i class="fa-solid fa-user-shield"></i> ƒêƒÉng nh·∫≠p Admin
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <main class="pt-20">
        
        <section id="home" class="min-h-[60vh] flex flex-col justify-center items-center px-4 py-12 relative">
            <div class="text-center mb-12" data-aos="fade-down">
                <span class="inline-block py-1 px-3 rounded-full bg-purple-500/20 border border-purple-500/50 text-purple-300 text-xs font-bold tracking-widest uppercase mb-4">V≈© Tr·ª• Audio ƒêam M·ªπ</span>
                <h1 class="text-4xl md:text-6xl font-black text-white mb-4 drop-shadow-xl">
                    Top <span class="text-gradient">Th·ªãnh H√†nh</span>
                </h1>
                <p class="text-gray-400 max-w-lg mx-auto text-sm md:text-base">Nh·ªØng b·ªô truy·ªán ƒë∆∞·ª£c c·ªông ƒë·ªìng y√™u th√≠ch nh·∫•t tu·∫ßn qua.</p>
            </div>

            <div id="loadingTop" class="loader"></div>
            <div id="topStories" class="flex flex-wrap justify-center gap-6 w-full max-w-6xl z-10">
                </div>
        </section>

        <section id="reading" class="max-w-7xl mx-auto px-4 py-16" data-aos="fade-up">
            <div class="flex items-center gap-4 mb-8">
                <div class="w-10 h-10 rounded-full bg-red-500/20 flex items-center justify-center text-red-500 shadow-[0_0_15px_rgba(239,68,68,0.4)]">
                    <i class="fa-solid fa-podcast text-xl animate-pulse"></i>
                </div>
                <div>
                    <h2 class="text-2xl font-bold text-white">ƒêang L√™n S√≥ng</h2>
                    <p class="text-xs text-gray-400">C√°c b·ªô truy·ªán ƒëang ƒë∆∞·ª£c chuy·ªÉn th·ªÉ Audio</p>
                </div>
            </div>
            
            <div id="readingList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                </div>
        </section>

        <section id="suggest" class="max-w-3xl mx-auto px-4 py-16 mb-12" data-aos="fade-up">
            <div class="glass-panel rounded-3xl p-8 border border-purple-500/30 relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-purple-500 to-pink-500"></div>
                
                <h2 class="text-2xl font-bold text-center mb-6 text-white"><i class="fa-solid fa-meteor text-purple-400 mr-2"></i> ƒê√≥ng G√≥p Truy·ªán M·ªõi</h2>
                <p class="text-center text-gray-400 text-sm mb-6">H√£y ƒë·ªÅ xu·∫•t nh·ªØng b·ªô truy·ªán b·∫°n mu·ªën nghe. Admin s·∫Ω xem x√©t v√† chuy·ªÉn th·ªÉ.</p>
                
                <form id="formSuggest" class="space-y-5">
                    <div class="grid md:grid-cols-2 gap-5">
                        <div class="space-y-1">
                            <label class="text-xs font-bold text-gray-400 ml-2">T√™n truy·ªán</label>
                            <input id="title" class="w-full bg-black/30 border border-white/10 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 transition" placeholder="Nh·∫≠p t√™n truy·ªán..." required>
                        </div>
                        <div class="space-y-1">
                            <label class="text-xs font-bold text-gray-400 ml-2">Link g·ªëc</label>
                            <input id="linkStory" type="url" class="w-full bg-black/30 border border-white/10 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 transition" placeholder="https://..." required>
                        </div>
                    </div>

                    <div class="flex gap-4 px-2">
                        <label class="flex items-center gap-2 cursor-pointer group">
                            <div class="relative w-5 h-5 rounded-full border-2 border-gray-500 flex items-center justify-center transition group-hover:border-blue-400">
                                <input type="radio" name="version" value="Edit" class="appearance-none absolute inset-0 rounded-full checked:bg-blue-500 checked:border-blue-500" required>
                            </div>
                            <span class="text-sm font-semibold text-gray-300 group-hover:text-blue-400 transition">B·∫£n Edit</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer group">
                            <div class="relative w-5 h-5 rounded-full border-2 border-gray-500 flex items-center justify-center transition group-hover:border-orange-400">
                                <input type="radio" name="version" value="Convert" class="appearance-none absolute inset-0 rounded-full checked:bg-orange-500 checked:border-orange-500">
                            </div>
                            <span class="text-sm font-semibold text-gray-300 group-hover:text-orange-400 transition">B·∫£n Convert</span>
                        </label>
                    </div>

                    <div class="space-y-1">
                        <textarea id="note" rows="3" class="w-full bg-black/30 border border-white/10 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 transition resize-none" placeholder="L·ªùi nh·∫Øn g·ª≠i t·ªõi Admin..."></textarea>
                    </div>

                    <button type="submit" class="w-full py-3.5 rounded-xl bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold tracking-wide shadow-lg shadow-purple-900/40 hover:shadow-purple-600/60 hover:-translate-y-1 transition-all duration-300 flex items-center justify-center gap-2">
                        <i class="fa-solid fa-paper-plane"></i> G·ª¨I ƒê·ªÄ XU·∫§T
                    </button>
                </form>
            </div>
        </section>

        <section id="list" class="max-w-7xl mx-auto px-4 py-16 relative">
            <div class="glass-panel rounded-3xl p-6 md:p-8 overflow-hidden">
                <div class="flex flex-col md:flex-row justify-between items-center gap-6 mb-8">
                    <h2 class="text-2xl font-bold text-white flex items-center gap-2">
                        <i class="fa-solid fa-book-open text-purple-400"></i> Kho T√†ng
                    </h2>
                    
                    <div class="flex w-full md:w-auto gap-3 bg-black/20 p-1.5 rounded-2xl border border-white/10">
                        <div class="relative flex-1 md:w-64">
                            <i class="fa-solid fa-search absolute left-3 top-3 text-gray-500 text-sm"></i>
                            <input id="searchInput" onkeyup="handleSearch()" class="w-full bg-transparent text-sm text-white pl-9 pr-4 py-2 focus:outline-none placeholder-gray-500" placeholder="T√¨m t√™n truy·ªán...">
                        </div>
                        <select id="sortSelect" onchange="handleSearch()" class="bg-white/10 text-white text-xs font-bold py-2 px-4 rounded-xl border-none focus:ring-0 cursor-pointer hover:bg-white/20 transition">
                            <option value="vote" class="bg-gray-900">üî• Hot</option>
                            <option value="new" class="bg-gray-900">‚ú® M·ªõi</option>
                        </select>
                    </div>
                </div>

                <div id="loadingList" class="loader"></div>

                <div class="hidden md:block overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead class="text-gray-400 text-xs uppercase font-bold border-b border-white/10">
                            <tr>
                                <th class="pb-4 pl-4">T√™n Truy·ªán</th>
                                <th class="pb-4 text-center">Lo·∫°i</th>
                                <th class="pb-4">Note</th>
                                <th class="pb-4 text-center">Y√™u th√≠ch</th>
                                <th class="pb-4 text-right pr-4">Link</th>
                            </tr>
                        </thead>
                        <tbody id="storyList" class="text-sm text-gray-300 divide-y divide-white/5"></tbody>
                    </table>
                </div>

                <div id="storyListMobile" class="md:hidden space-y-4"></div>

                <div class="text-center mt-8">
                    <button id="loadMoreBtn" onclick="loadMore()" class="hidden px-6 py-2.5 rounded-full bg-white/5 border border-white/10 hover:bg-white/10 text-gray-300 font-bold text-sm transition-all hover:scale-105">
                        Xem th√™m <i class="fa-solid fa-chevron-down ml-1"></i>
                    </button>
                </div>
            </div>
        </section>

        <section id="admin" class="hidden fixed inset-0 z-[60] bg-black/90 backdrop-blur-md overflow-y-auto">
            <div class="min-h-screen p-4 md:p-8">
                <div class="max-w-7xl mx-auto bg-[#13131f] border border-white/10 rounded-2xl shadow-2xl overflow-hidden relative">
                    <button id="closeAdminBtn" class="absolute top-4 right-4 text-gray-400 hover:text-white p-2"><i class="fa-solid fa-xmark text-xl"></i></button>

                    <div class="p-6 md:p-8 border-b border-white/10 flex flex-col md:flex-row justify-between items-start md:items-center gap-4 bg-gradient-to-r from-gray-900 to-gray-800">
                        <div>
                            <h2 class="text-2xl font-bold text-white flex items-center gap-2"><span class="text-purple-500"><i class="fa-solid fa-user-astronaut"></i></span> Admin Control</h2>
                            <p class="text-gray-400 text-xs mt-1">Qu·∫£n l√Ω kho d·ªØ li·ªáu v≈© tr·ª•</p>
                        </div>
                        <div class="flex gap-3">
                             <input id="adminSearch" onkeyup="renderAdmin()" class="bg-black/40 border border-white/10 text-white text-sm rounded-lg px-4 py-2 focus:border-purple-500 outline-none" placeholder="T√¨m ki·∫øm...">
                             <select id="adminFilter" onchange="renderAdmin()" class="bg-black/40 border border-white/10 text-white text-sm rounded-lg px-3 outline-none">
                                <option value="all">T·∫•t c·∫£</option>
                                <option value="ƒë·ªÅ‚ÄØxu·∫•t">ƒê·ªÅ xu·∫•t</option>
                                <option value="ƒëang‚ÄØƒë·ªçc">ƒêang ph√°t</option>
                             </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-4 gap-0 divide-x divide-y divide-white/5 bg-white/[0.02]">
                        <div class="p-6 text-center">
                            <p class="text-gray-500 text-xs font-bold uppercase mb-1">T·ªïng s·ªë</p>
                            <p class="text-3xl font-bold text-white" id="statTotal">0</p>
                        </div>
                        <div class="p-6 text-center">
                            <p class="text-yellow-500 text-xs font-bold uppercase mb-1">C·∫ßn duy·ªát</p>
                            <p class="text-3xl font-bold text-yellow-400" id="statSuggest">0</p>
                        </div>
                        <div class="p-6 text-center">
                            <p class="text-green-500 text-xs font-bold uppercase mb-1">On Air</p>
                            <p class="text-3xl font-bold text-green-400" id="statReading">0</p>
                        </div>
                        <div class="p-6 text-center">
                            <p class="text-purple-500 text-xs font-bold uppercase mb-1">Ho√†n th√†nh</p>
                            <p class="text-3xl font-bold text-purple-400" id="statDone">0</p>
                        </div>
                    </div>

                    <div class="p-0 overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead class="bg-white/5 text-gray-400 text-xs uppercase font-bold">
                                <tr>
                                    <th class="p-4">Truy·ªán</th>
                                    <th class="p-4">Tr·∫°ng th√°i</th>
                                    <th class="p-4 text-center">Votes</th>
                                    <th class="p-4">Youtube</th>
                                    <th class="p-4 text-right">H√†nh ƒë·ªông</th>
                                </tr>
                            </thead>
                            <tbody id="adminTable" class="text-sm divide-y divide-white/5 text-gray-300"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <footer class="mt-12 py-8 text-center text-gray-600 text-xs border-t border-white/5 glass-panel">
        <p>&copy; 2026 H·ªìi √Çm ƒêam M·ªπ. Design by Galaxy.</p>
    </footer>

    <button id="backToTop" onclick="window.scrollTo({top:0,behavior:'smooth'})" class="fixed bottom-6 right-6 w-12 h-12 bg-purple-600 text-white rounded-full shadow-lg shadow-purple-600/40 flex items-center justify-center translate-y-20 opacity-0 transition-all duration-300 hover:bg-purple-500 z-40">
        <i class="fa-solid fa-chevron-up"></i>
    </button>

<script>
    AOS.init({ once: true, offset: 50, duration: 800 });

    // --- SUPABASE CONFIG ---
    const SUPABASE_URL = 'https://xklmcebwxkqbotqexprn.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhrbG1jZWJ3eGtxYm90cWV4cHJuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2MzM1NDEsImV4cCI6MjA3OTIwOTU0MX0.vZj-5C_HhVgemG0LOTH3axf4P0bxXngzeQ3PSo93-m4';
    const TABLE = 'stories';
    const ADMIN_HASH = 'aG9pYW0yMDEwMjAwMw==';

    let stories = [];
    let debounceTimer;
    let visibleLimit = 10; // Hi·ªÉn th·ªã m·∫∑c ƒë·ªãnh 10 truy·ªán

    // --- STARS BACKGROUND ---
    const canvas = document.getElementById("stars");
    const ctx = canvas.getContext("2d");
    function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    window.onresize = resize; resize();
    
    const starsArray = Array(100).fill().map(() => ({
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height,
        r: Math.random() * 1.5,
        o: Math.random(),
        dx: (Math.random() - 0.5) * 0.2,
        dy: (Math.random() - 0.5) * 0.2
    }));

    function animateStars() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = "white";
        starsArray.forEach(s => {
            ctx.globalAlpha = s.o;
            ctx.beginPath(); ctx.arc(s.x, s.y, s.r, 0, Math.PI * 2); ctx.fill();
            s.x += s.dx; s.y += s.dy;
            if (s.x < 0 || s.x > canvas.width) s.x = Math.random() * canvas.width;
            if (s.y < 0 || s.y > canvas.height) s.y = Math.random() * canvas.height;
        });
        requestAnimationFrame(animateStars);
    }
    animateStars();

    // --- UTILS ---
    const getYoutubeID = (url) => {
        const match = url?.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/);
        return (match && match[2].length === 11) ? match[2] : null;
    };

    function handleSearch() {
        visibleLimit = 10; // Reset limit khi t√¨m ki·∫øm
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(filterStories, 300);
    }

    function loadMore() {
        visibleLimit += 10;
        filterStories();
    }

    // --- DATA FETCHING ---
    async function fetchStories() {
        document.getElementById('loadingTop').style.display = 'block';
        document.getElementById('loadingList').style.display = 'block';
        try {
            const res = await fetch(`${SUPABASE_URL}/rest/v1/${TABLE}?select=*`, {
                headers: { apikey: SUPABASE_KEY, Authorization: `Bearer ${SUPABASE_KEY}` }
            });
            if (!res.ok) throw new Error('Err');
            stories = await res.json();
            refresh();
        } catch (e) { console.error(e); } 
        finally {
            document.getElementById('loadingTop').style.display = 'none';
            document.getElementById('loadingList').style.display = 'none';
        }
    }

    async function updateStory(id, d) {
        await fetch(`${SUPABASE_URL}/rest/v1/${TABLE}?id=eq.${id}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json', apikey: SUPABASE_KEY, Authorization: `Bearer ${SUPABASE_KEY}` },
            body: JSON.stringify(d)
        });
        const idx = stories.findIndex(s => s.id === id);
        if (idx !== -1) stories[idx] = { ...stories[idx], ...d };
        refresh();
    }

    async function deleteStory(id) {
        if((await Swal.fire({title:'X√≥a?',icon:'warning',showCancelButton:true, confirmButtonColor: '#d33'})).isConfirmed){
            await fetch(`${SUPABASE_URL}/rest/v1/${TABLE}?id=eq.${id}`, { method: 'DELETE', headers: { apikey: SUPABASE_KEY, Authorization: `Bearer ${SUPABASE_KEY}` }});
            stories = stories.filter(s => s.id !== id);
            refresh();
            Swal.fire('Deleted!', '', 'success');
        }
    }

    // --- INTERACTION ---
    function toggleVote(id) {
        const btn = document.querySelector(`.vote-btn-${id}`);
        const count = document.getElementById(`vote-count-${id}`);
        const s = stories.find(x => x.id === id);
        if (!s) return;

        let v = s.votes || 0;
        const key = `vote_${id}`;

        if (localStorage.getItem(key)) {
            localStorage.removeItem(key); v--;
            btn.classList.remove('active', 'text-red-500');
            btn.classList.add('text-gray-400');
        } else {
            localStorage.setItem(key, 'true'); v++;
            btn.classList.add('active', 'text-red-500');
            btn.classList.remove('text-gray-400');
            
            // Effect
            const heart = document.createElement('div');
            heart.innerHTML = '‚ù§Ô∏è';
            heart.style.position = 'absolute';
            heart.style.left = `${btn.getBoundingClientRect().left}px`;
            heart.style.top = `${btn.getBoundingClientRect().top}px`;
            heart.style.transition = '1s';
            heart.style.pointerEvents = 'none';
            document.body.appendChild(heart);
            setTimeout(() => { heart.style.transform = 'translateY(-50px) scale(1.5)'; heart.style.opacity = '0'; }, 50);
            setTimeout(() => heart.remove(), 1000);
        }
        
        s.votes = v;
        if(count) count.innerText = v;
        clearTimeout(window[`vt_${id}`]);
        window[`vt_${id}`] = setTimeout(() => updateStory(id, { votes: v }), 1500);
    }

    document.getElementById('formSuggest').addEventListener("submit", async e => {
        e.preventDefault();
        const btn = e.target.querySelector('button');
        const oldTxt = btn.innerHTML;
        
        // Cooldown Check
        const last = localStorage.getItem('last_submit');
        if(last && Date.now() - last < 300000) return Swal.fire('Ch·∫≠m l·∫°i!', 'Vui l√≤ng ƒë·ª£i 5 ph√∫t.', 'warning');

        btn.disabled = true; btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ƒêang g·ª≠i...';
        
        try {
            const link = document.getElementById('linkStory').value.trim();
            // Duplicate Check
            const check = await fetch(`${SUPABASE_URL}/rest/v1/${TABLE}?linkstory=eq.${encodeURIComponent(link)}`, { headers: { apikey: SUPABASE_KEY, Authorization: `Bearer ${SUPABASE_KEY}` } });
            if((await check.json()).length > 0) throw new Error('Dup');

            await fetch(`${SUPABASE_URL}/rest/v1/${TABLE}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', apikey: SUPABASE_KEY, Authorization: `Bearer ${SUPABASE_KEY}` },
                body: JSON.stringify({
                    title: document.getElementById('title').value.trim(),
                    linkstory: link,
                    version: document.querySelector('input[name="version"]:checked').value,
                    note: document.getElementById('note').value.trim(),
                    votes: 0, status: 'ƒë·ªÅ‚ÄØxu·∫•t', youtubelink: '', createdat: new Date().toISOString()
                })
            });
            localStorage.setItem('last_submit', Date.now());
            e.target.reset();
            Swal.fire({icon: 'success', title: 'ƒê√£ g·ª≠i!', background:'#1f2937', color:'#fff', confirmButtonColor:'#8B5CF6'});
        } catch(err) {
            if(err.message === 'Dup') Swal.fire('Tr√πng l·∫∑p!', 'Truy·ªán n√†y ƒë√£ c√≥ ng∆∞·ªùi g·ª≠i.', 'info');
            else Swal.fire('L·ªói', 'Th·ª≠ l·∫°i sau.', 'error');
        } finally {
            btn.disabled = false; btn.innerHTML = oldTxt;
        }
    });

    // --- RENDER ---
    function refresh() {
        filterStories();
        if(!document.getElementById('admin').classList.contains('hidden')) renderAdmin();
    }

    function filterStories() {
        const kw = document.getElementById('searchInput').value.toLowerCase();
        const sort = document.getElementById('sortSelect').value;
        let list = stories.filter(s => s.status === 'ƒë·ªÅ‚ÄØxu·∫•t' && s.title.toLowerCase().includes(kw));

        if (sort === 'vote') list.sort((a, b) => b.votes - a.votes);
        else list.sort((a, b) => new Date(b.createdat) - new Date(a.createdat));

        // Logic Load More
        const total = list.length;
        const visibleList = list.slice(0, visibleLimit);
        
        const btnMore = document.getElementById('loadMoreBtn');
        if(total > visibleLimit) btnMore.classList.remove('hidden');
        else btnMore.classList.add('hidden');

        renderTop(list);
        renderReading();
        renderListPC(visibleList);
        renderListMobile(visibleList);
    }

    function renderTop(list) {
        const c = document.getElementById('topStories'); c.innerHTML = '';
        const top = [...list].sort((a, b) => b.votes - a.votes).slice(0, 3);
        
        top.forEach((s, i) => {
            const colors = ['from-yellow-400 to-orange-500', 'from-gray-300 to-gray-400', 'from-orange-400 to-red-500'];
            const rank = i + 1;
            c.innerHTML += `
            <div class="relative group w-80">
                <div class="absolute inset-0 bg-gradient-to-r ${colors[i]} rounded-2xl blur opacity-25 group-hover:opacity-50 transition duration-500"></div>
                <div class="relative bg-gray-900/90 backdrop-blur border border-white/10 p-5 rounded-2xl h-full flex flex-col transform transition hover:-translate-y-2">
                    <div class="absolute -top-4 -left-4 w-10 h-10 rounded-full bg-gradient-to-br ${colors[i]} flex items-center justify-center text-white font-bold shadow-lg">#${rank}</div>
                    <h3 class="text-lg font-bold text-white mb-2 line-clamp-2 mt-2">${s.title}</h3>
                    <p class="text-xs text-gray-400 mb-4 line-clamp-2 italic">"${s.note || 'Kh√¥ng c√≥ ghi ch√∫'}"</p>
                    <div class="mt-auto flex justify-between items-center border-t border-white/5 pt-3">
                        <span class="text-pink-500 font-bold text-sm"><i class="fa-solid fa-heart mr-1"></i> ${s.votes}</span>
                        ${s.linkstory ? `<a href="${s.linkstory}" target="_blank" class="text-purple-400 hover:text-white text-sm font-semibold">ƒê·ªçc ngay <i class="fa-solid fa-arrow-right ml-1"></i></a>` : ''}
                    </div>
                </div>
            </div>`;
        });
    }

    function renderReading() {
        const list = stories.filter(s => s.status === 'ƒëang‚ÄØƒë·ªçc');
        const c = document.getElementById('readingList');
        c.innerHTML = list.length ? list.map(s => {
            const vid = getYoutubeID(s.youtubelink);
            const thumb = vid ? `https://img.youtube.com/vi/${vid}/mqdefault.jpg` : '';
            return `
            <div class="group relative rounded-2xl overflow-hidden aspect-video bg-gray-800 border border-white/10 shadow-lg cursor-pointer" onclick="window.open('${s.youtubelink}', '_blank')">
                ${thumb ? `<img src="${thumb}" class="w-full h-full object-cover opacity-60 group-hover:opacity-40 group-hover:scale-105 transition duration-700">` : ''}
                <div class="absolute inset-0 flex flex-col justify-end p-4 bg-gradient-to-t from-black via-black/50 to-transparent">
                    <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-12 h-12 bg-white/10 backdrop-blur-sm rounded-full flex items-center justify-center border border-white/30 group-hover:scale-110 transition">
                        <i class="fa-solid fa-play text-white ml-1"></i>
                    </div>
                    <h3 class="text-white font-bold text-lg leading-tight text-shadow">${s.title}</h3>
                    <div class="flex items-center gap-2 mt-2">
                         <span class="inline-block w-2 h-2 rounded-full bg-red-500 animate-pulse"></span>
                         <span class="text-xs text-red-400 font-bold uppercase tracking-wider">On Air</span>
                    </div>
                </div>
            </div>`;
        }).join('') : '<div class="col-span-full text-center text-gray-500 py-10 italic">Ch∆∞a c√≥ truy·ªán n√†o ƒëang ph√°t...</div>';
    }

    function renderListPC(list) {
        const tb = document.getElementById('storyList'); tb.innerHTML = '';
        list.forEach(s => {
            const isLiked = localStorage.getItem(`vote_${s.id}`);
            tb.innerHTML += `
            <tr class="hover:bg-white/5 transition group">
                <td class="p-4 pl-4 font-semibold text-gray-200">
                    <a href="${s.linkstory}" target="_blank" class="hover:text-purple-400 transition">${s.title}</a>
                    ${((new Date() - new Date(s.createdat)) / 86400000 < 3) ? '<span class="ml-2 px-1.5 py-0.5 bg-green-500/20 text-green-400 text-[10px] rounded font-bold border border-green-500/30">NEW</span>' : ''}
                </td>
                <td class="p-4 text-center">
                    <span class="px-2 py-1 rounded text-[10px] font-bold border ${s.version === 'Edit' ? 'bg-blue-500/10 text-blue-400 border-blue-500/30' : 'bg-orange-500/10 text-orange-400 border-orange-500/30'}">${s.version}</span>
                </td>
                <td class="p-4 text-xs italic text-gray-500 max-w-xs truncate">${s.note || '-'}</td>
                <td class="p-4 text-center">
                    <button onclick="toggleVote(${s.id})" class="heart-pop vote-btn-${s.id} ${isLiked ? 'text-red-500' : 'text-gray-400'} hover:text-red-400 transition text-lg">
                        <i class="fa-solid fa-heart"></i>
                    </button>
                    <span id="vote-count-${s.id}" class="text-xs ml-1 font-bold text-gray-500">${s.votes}</span>
                </td>
                <td class="p-4 text-right pr-4">
                    ${s.linkstory ? `<a href="${s.linkstory}" target="_blank" class="w-8 h-8 inline-flex items-center justify-center rounded-full bg-white/5 hover:bg-purple-600 hover:text-white transition"><i class="fa-solid fa-arrow-up-right-from-square text-xs"></i></a>` : ''}
                </td>
            </tr>`;
        });
    }

    function renderListMobile(list) {
        const mb = document.getElementById('storyListMobile'); mb.innerHTML = '';
        list.forEach(s => {
            const isLiked = localStorage.getItem(`vote_${s.id}`);
            mb.innerHTML += `
            <div class="glass-panel p-4 rounded-2xl flex items-start gap-3">
                <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-2 mb-1">
                        <span class="px-1.5 py-0.5 rounded text-[9px] font-bold border ${s.version === 'Edit' ? 'bg-blue-500/10 text-blue-400 border-blue-500/30' : 'bg-orange-500/10 text-orange-400 border-orange-500/30'}">${s.version}</span>
                        ${((new Date() - new Date(s.createdat)) / 86400000 < 3) ? '<span class="text-[9px] text-green-400 font-bold">NEW</span>' : ''}
                    </div>
                    <h4 class="font-bold text-white text-base leading-tight mb-2">${s.title}</h4>
                    <p class="text-xs text-gray-400 italic line-clamp-2 mb-2">"${s.note || '...'}"</p>
                    ${s.linkstory ? `<a href="${s.linkstory}" target="_blank" class="text-purple-400 text-xs font-bold hover:underline">ƒê·ªçc ngay</a>` : ''}
                </div>
                <div class="flex flex-col items-center justify-center pl-3 border-l border-white/10">
                    <button onclick="toggleVote(${s.id})" class="heart-pop vote-btn-${s.id} ${isLiked ? 'text-red-500' : 'text-gray-400'} text-xl mb-1">
                        <i class="fa-solid fa-heart"></i>
                    </button>
                    <span id="vote-count-${s.id}" class="text-[10px] font-bold text-gray-500">${s.votes}</span>
                </div>
            </div>`;
        });
    }

    // --- ADMIN LOGIC ---
    const checkAdmin = async () => {
        const { value: p } = await Swal.fire({
            title: 'Admin Access', input: 'password', inputPlaceholder: 'M·∫≠t kh·∫©u...',
            background: '#1f2937', color: '#fff', confirmButtonColor: '#8B5CF6'
        });
        if (p && btoa(p) === ADMIN_HASH) {
            document.getElementById('admin').classList.remove('hidden');
            renderAdmin();
        } else if(p) Swal.fire('Sai m·∫≠t kh·∫©u!', '', 'error');
    }
    
    document.getElementById('adminLoginBtn').onclick = checkAdmin;
    document.getElementById('adminLoginBtnMobile').onclick = checkAdmin;
    document.getElementById('closeAdminBtn').onclick = () => document.getElementById('admin').classList.add('hidden');

    function renderAdmin() {
        const kw = document.getElementById('adminSearch').value.toLowerCase();
        const f = document.getElementById('adminFilter').value;
        const list = stories.filter(s => (f === 'all' || s.status === f) && s.title.toLowerCase().includes(kw));
        
        // Stats
        document.getElementById('statTotal').innerText = stories.length;
        document.getElementById('statSuggest').innerText = stories.filter(s => s.status === 'ƒë·ªÅ‚ÄØxu·∫•t').length;
        document.getElementById('statReading').innerText = stories.filter(s => s.status === 'ƒëang‚ÄØƒë·ªçc').length;
        document.getElementById('statDone').innerText = stories.filter(s => s.status === 'ƒë√£‚ÄØƒë·ªçc').length;

        const tb = document.getElementById('adminTable'); tb.innerHTML = '';
        list.forEach(s => {
            const statusColor = s.status === 'ƒë·ªÅ‚ÄØxu·∫•t' ? 'text-yellow-400' : (s.status === 'ƒëang‚ÄØƒë·ªçc' ? 'text-green-400' : 'text-purple-400');
            tb.innerHTML += `
            <tr class="hover:bg-white/5 transition border-b border-white/5 last:border-0">
                <td class="p-4">
                    <div class="font-bold text-white mb-1">${s.title}</div>
                    <a href="${s.linkstory}" target="_blank" class="text-xs text-gray-500 hover:text-purple-400 truncate block max-w-[150px]"><i class="fa-solid fa-link"></i> Link g·ªëc</a>
                </td>
                <td class="p-4"><span class="text-xs font-bold uppercase ${statusColor} border border-current px-2 py-1 rounded-md">${s.status}</span></td>
                <td class="p-4 text-center font-bold text-pink-400">${s.votes}</td>
                <td class="p-4 text-xs text-gray-400 truncate max-w-[100px]">${s.youtubelink ? '<i class="fa-brands fa-youtube text-red-500"></i> C√≥' : '-'}</td>
                <td class="p-4 text-right">
                    <button onclick="editAdmin(${s.id})" class="text-blue-400 hover:text-blue-300 mr-3"><i class="fa-solid fa-pen"></i></button>
                    <button onclick="deleteStory(${s.id})" class="text-red-400 hover:text-red-300"><i class="fa-solid fa-trash"></i></button>
                </td>
            </tr>`;
        });
    }

    function editAdmin(id) {
        const s = stories.find(x => x.id === id);
        Swal.fire({
            title: 'S·ª≠a Truy·ªán / TƒÉng Vote',
            background: '#1f2937', color: '#fff',
            html: `
                <div class="text-left mb-2 text-xs text-gray-400 font-bold uppercase">Th√¥ng tin chung</div>
                <input id="e-title" class="swal2-input bg-gray-700 text-white" value="${s.title}" placeholder="T√™n truy·ªán">
                <input id="e-link" class="swal2-input bg-gray-700 text-white" value="${s.linkstory || ''}" placeholder="Link g·ªëc">
                <input id="e-yt" class="swal2-input bg-gray-700 text-white" value="${s.youtubelink || ''}" placeholder="Link Youtube">
                
                <div class="text-left mt-4 mb-2 text-xs text-gray-400 font-bold uppercase">Tr·∫°ng th√°i & Vote</div>
                <div class="flex gap-2">
                    <select id="e-status" class="swal2-input bg-gray-700 text-white w-2/3">
                        <option value="ƒë·ªÅ‚ÄØxu·∫•t" ${s.status === 'ƒë·ªÅ‚ÄØxu·∫•t' ? 'selected' : ''}>ƒê·ªÅ xu·∫•t</option>
                        <option value="ƒëang‚ÄØƒë·ªçc" ${s.status === 'ƒëang‚ÄØƒë·ªçc' ? 'selected' : ''}>ƒêang ph√°t</option>
                        <option value="ƒë√£‚ÄØƒë·ªçc" ${s.status === 'ƒë√£‚ÄØƒë·ªçc' ? 'selected' : ''}>ƒê√£ ƒë·ªçc</option>
                    </select>
                    <input id="e-votes" type="number" class="swal2-input bg-gray-700 text-white w-1/3 text-center font-bold text-pink-400" value="${s.votes}" placeholder="Vote">
                </div>
            `,
            confirmButtonText: 'L∆∞u thay ƒë·ªïi', confirmButtonColor: '#8B5CF6',
            preConfirm: () => ({
                title: document.getElementById('e-title').value,
                linkstory: document.getElementById('e-link').value,
                youtubelink: document.getElementById('e-yt').value,
                status: document.getElementById('e-status').value,
                votes: parseInt(document.getElementById('e-votes').value) || 0
            })
        }).then(r => { 
            if(r.isConfirmed) {
                updateStory(id, r.value);
                Swal.fire({icon: 'success', title: 'ƒê√£ c·∫≠p nh·∫≠t!', background: '#1f2937', color: '#fff', timer: 1500, showConfirmButton: false});
            }
        });
    }

    // --- MISC ---
    const btnTop = document.getElementById('backToTop');
    window.onscroll = () => {
        if(document.documentElement.scrollTop > 300) {
            btnTop.classList.remove('translate-y-20', 'opacity-0');
        } else {
            btnTop.classList.add('translate-y-20', 'opacity-0');
        }
    }
    
    // Mobile Menu Toggle
    const menuBtn = document.getElementById('mobileMenuBtn');
    const mobileMenu = document.getElementById('mobileMenu');
    menuBtn.addEventListener('click', () => {
        mobileMenu.classList.toggle('hidden');
    });

    // Init
    window.onload = fetchStories;
</script>
</body>
</html>
